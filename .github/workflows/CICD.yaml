name: Node js App

on:
  push:
    branches:
      - main

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "version: \"$VERSION\"" > version.yaml
          ls -l

      - name: Debugging the extracted version
        run: echo "VERSION is ${{ env.VERSION }}"

      - name: Upload Version artifact
        uses: actions/upload-artifact@v4
        with:
          name: version
          path: version.yaml

  build:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
          - name: Checkout repo
            uses: actions/checkout@v4

          - name: Download artifact
            uses: actions/download-artifact@v4
            with:
             name: version
             path: .

          - name: Load version into environment
            run: |
              VERSION=$(grep 'version:' version.yaml | cut -d'"' -f2)
              echo "VERSION=$VERSION" >> "$GITHUB_ENV"
              echo "Using version $VERSION"

          - name: Setup Nodejs
            uses: actions/setup-node@v4
            with:
              node-version: "20"
              cache: 'npm'

          - name: Install dep
            run: npm i
          - name: Package app artifact
            run: |
             ARTIFACT_NAME="nodeapp-${VERSION}-${GITHUB_SHA:0:7}.tgz"
             mkdir -p artifacts
             mkdir -p artifact-temp
             shopt -s extglob
             cp -r !(artifact-temp|artifacts|.git|.github) artifact-temp/
             tar -czf "artifacts/$ARTIFACT_NAME" -C artifact-temp .
             rm -rf artifact-temp
             ls -R artifacts

          - name: Upload build artifacts
            uses: actions/upload-artifact@v4
            with:
              name: app-build
              path: artifacts/

  docker:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: version

      - name: Load version into environment
        run: |
          VERSION=$(grep 'version:' version.yaml | cut -d'"' -f2)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Using version $VERSION"

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.Docker_UNAME }}
          password: ${{ secrets.Docker_PAT }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: basil6789/nodeapp:${{ env.VERSION }}

  deploy:
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - name: Download version artifact
        uses: actions/download-artifact@v4
        with:
          name: version

      - name: Load version into environment
        run: |
          VERSION=$(grep 'version:' version.yaml | cut -d'"' -f2)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: SSH to server and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.HOST_NAME }}
          key: ${{ secrets.KEY }}
          port: 22
          script: |
            echo "Remote deploy"
            docker pull basil6789/nodeapp:${VERSION}
            docker stop nodeapp || true
            docker rm nodeapp || true
            docker run -d -p 81:3000 --name nodeapp basil6789/nodeapp:${VERSION}
            docker ps
